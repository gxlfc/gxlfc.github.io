<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>做一个充满好奇的人</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.776c6a58.css" as="style"><link rel="preload" href="/assets/js/app.91ba7cf5.js" as="script"><link rel="preload" href="/assets/js/2.9e0e5fe5.js" as="script"><link rel="preload" href="/assets/js/16.0688abe9.js" as="script"><link rel="prefetch" href="/assets/js/10.751c16cd.js"><link rel="prefetch" href="/assets/js/11.89ff16e3.js"><link rel="prefetch" href="/assets/js/12.ce07b6fd.js"><link rel="prefetch" href="/assets/js/13.75455f49.js"><link rel="prefetch" href="/assets/js/14.68a47930.js"><link rel="prefetch" href="/assets/js/15.93ebd277.js"><link rel="prefetch" href="/assets/js/17.eea6fe83.js"><link rel="prefetch" href="/assets/js/18.1714b340.js"><link rel="prefetch" href="/assets/js/19.e0c537e6.js"><link rel="prefetch" href="/assets/js/20.73330bf5.js"><link rel="prefetch" href="/assets/js/21.19857d8f.js"><link rel="prefetch" href="/assets/js/22.79fc061b.js"><link rel="prefetch" href="/assets/js/23.d764e1c7.js"><link rel="prefetch" href="/assets/js/24.3c1feccb.js"><link rel="prefetch" href="/assets/js/25.4fe9d40c.js"><link rel="prefetch" href="/assets/js/26.358b13d3.js"><link rel="prefetch" href="/assets/js/27.10273dbe.js"><link rel="prefetch" href="/assets/js/28.aa1386df.js"><link rel="prefetch" href="/assets/js/29.2e17ad6b.js"><link rel="prefetch" href="/assets/js/3.475d1549.js"><link rel="prefetch" href="/assets/js/4.844b3f19.js"><link rel="prefetch" href="/assets/js/5.3b3e6503.js"><link rel="prefetch" href="/assets/js/6.fcd77232.js"><link rel="prefetch" href="/assets/js/7.32ff2203.js"><link rel="prefetch" href="/assets/js/8.a379ac59.js"><link rel="prefetch" href="/assets/js/9.7b3946aa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.776c6a58.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">做一个充满好奇的人</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/gxlfc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/gxlfc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe/css.html" class="sidebar-link">CSS</a></li><li><a href="/fe/function.html" class="sidebar-link">函数式编程</a></li><li><a href="/fe/class.html" class="sidebar-link">原生对象&amp;新对象</a></li><li><a href="/fe/promise.html" class="active sidebar-link">Promise二三事</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/promise.html#promise-resolve-params" class="sidebar-link">promise.resolve(params)</a></li><li class="sidebar-sub-header"><a href="/fe/promise.html#promise-reject" class="sidebar-link">promise.reject</a></li><li class="sidebar-sub-header"><a href="/fe/promise.html#图片加载" class="sidebar-link">图片加载</a></li></ul></li><li><a href="/fe/iterator.html" class="sidebar-link">Iterator：遍历器 </a></li><li><a href="/fe/generator.html" class="sidebar-link">Generator：生成器</a></li><li><a href="/fe/webview.html" class="sidebar-link">浏览器</a></li><li><a href="/fe/node.html" class="sidebar-link">Node</a></li><li><a href="/fe/vue.html" class="sidebar-link">Vue</a></li><li><a href="/fe/react.html" class="sidebar-link">React</a></li><li><a href="/fe/webpack.html" class="sidebar-link">Webpack</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>后端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/android/" class="sidebar-heading clickable"><span>安卓</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/mode/" class="sidebar-link">设计模式</a></li><li><a href="/algorithm/" class="sidebar-link">数据结构和算法</a></li><li><a href="/pc/" class="sidebar-link">计算机基础</a></li><li><a href="/life/" class="sidebar-link">生活</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>es6出来后，一直在用async/await，业务代码非常优雅，很简短的几行代码，其中涉及的知识点还是有一丢丢多的；</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>aysnc <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>errno <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token comment">// ... 干点啥</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="feature："><a href="#feature：" class="header-anchor">#</a> feature：</h1> <ol><li>Pending、Fulfilled、Rejected 3中状态；</li> <li>状态不可逆，不可更改；</li> <li><strong>new promise创建后立即执行，then函数要等同步任务执行后才会执行</strong>；</li> <li><strong>调用resolve/reject并不会终结promise的参数函数的执行</strong>；</li></ol> <ul><li>但是（可恶），如果你在<strong>内部return了，就彻底凉了</strong>。不会再执行return后面语句；</li></ul> <ol start="5"><li>resolve/reject函数可以带参数，会被传递给回调函数；</li></ol> <ul><li>reject参数通常是一个Error对象实例;</li> <li>resolve参数通常是对象/值，也可以是一个promise对象。如下例；</li></ul> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">res</span><span class="token punctuation">(</span><span class="token string">'我没结束呢'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// return res('我彻底结束了');</span>
    <span class="token comment">// 立即resolve的Promise是在本轮事件循环的末尾执行，</span>
    <span class="token comment">// 总是晚于本轮事件循环的同步任务,所以如下结果会先输出；</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 就依赖p1的状态，是resolve还是reject</span>
    <span class="token function">res</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li><strong>catch</strong>等同于 new Promise(null, err =&gt; {}), 如果promise内部抛出错误（显示的reject/throw new Error/内部语法错误），也会被catch捕捉到</li></ol> <ul><li>如果<strong>promise状态已经变成了resolved，再抛出错误是无效的</strong></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">res</span><span class="token punctuation">(</span><span class="token string">'我结束了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 防在resolve后面再抛出错误，等于没有抛出</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'我错了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>错误具有冒泡性质，一直往后传，<strong>直到被catch为止</strong>，但catch也是promise，可以继续then链式调用；
<ul><li>如果后面的then再有报错，前面的catch爱莫能助；</li> <li>如果当前的catch抛出报错，后面没有写catch的话，这个错误会被淹没；</li></ul></li></ul> <h1 id="to-promise"><a href="#to-promise" class="header-anchor">#</a> to Promise</h1> <h2 id="promise-resolve-params"><a href="#promise-resolve-params" class="header-anchor">#</a> promise.resolve(params)</h2> <ul><li>promise实例 =&gt; 直接返回，不做处理</li> <li>thenable对象 =&gt; 将对象转化为promise对象，并且立即执行对象then方法；</li> <li>不带then方法/非对象 =&gt; 新的promise对象，状态是Resolved；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>不带任何参数 =&gt; 新的promise对象，状态是Resolved；</li></ul> <div class="custom-block tip"><p class="custom-block-title">执行时机</p> <p><strong>在本轮事件循环结束时，而不是下一轮事件循环开始时</strong></p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setTimeout 我们都知道是属于下一轮事件循环</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">333</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">var</span> a <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 本轮事件末尾</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="promise-reject"><a href="#promise-reject" class="header-anchor">#</a> promise.reject</h2> <p>返回新的promise对象，状态是rejected</p> <div class="custom-block tip"><p class="custom-block-title">不同于resolve</p> <p>原封不动的作为reject的理由/后续方法的操作</p></div> <h1 id="api"><a href="#api" class="header-anchor">#</a> Api</h1> <h3 id="promise-done"><a href="#promise-done" class="header-anchor">#</a> promise.done()</h3> <h3 id="promise-finally"><a href="#promise-finally" class="header-anchor">#</a> promise.finally()</h3> <h3 id="promise-try"><a href="#promise-try" class="header-anchor">#</a> promise.try()</h3> <h1 id="业务场景"><a href="#业务场景" class="header-anchor">#</a> 业务场景</h1> <h2 id="图片加载"><a href="#图片加载" class="header-anchor">#</a> 图片加载</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">asyncImage</span><span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 图像装载完毕时调用的事件句柄</span>
        image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">res</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 装载图像的过程中发生错误时调用的事件句柄</span>
        image<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">rej</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iamge<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参考资料</p> <ul><li>阮大大： ES6标准入门（第三版）</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/1/2020, 12:40:56 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe/class.html" class="prev">
        原生对象&amp;新对象
      </a></span> <span class="next"><a href="/fe/iterator.html">
        Iterator：遍历器 
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.91ba7cf5.js" defer></script><script src="/assets/js/2.9e0e5fe5.js" defer></script><script src="/assets/js/16.0688abe9.js" defer></script>
  </body>
</html>
